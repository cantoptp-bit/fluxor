name: deploy gateway

on:
  workflow_dispatch:
    inputs:
      ref:
        type: string
        required: false
        default: ''
        description: Optional git ref (defaults to the triggering branch)
  push:
    branches:
      - canary
    paths:
      - 'fluxer_gateway/**'

concurrency:
  group: deploy-gateway
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy (hot patch)
    runs-on: blacksmith-8vcpu-ubuntu-2404
    timeout-minutes: 25

    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ inputs.ref || '' }}
          sparse-checkout: |
            fluxer_gateway
            scripts/ci

      - name: Set up Erlang
        uses: erlef/setup-beam@v1
        with:
          otp-version: '28'
          rebar3-version: '3.24.0'

      - name: Compile
        run: python3 scripts/ci/workflows/deploy_gateway.py --step compile

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY_SERVER }}

      - name: Add server to known hosts
        run: python3 scripts/ci/workflows/deploy_gateway.py --step add_known_hosts --server-ip ${{ secrets.SERVER_IP }}

      - name: Record deploy commit
        run: python3 scripts/ci/workflows/deploy_gateway.py --step record_deploy_commit

      - name: Deploy
        env:
          SERVER: ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}
          GATEWAY_ADMIN_SECRET: ${{ secrets.GATEWAY_ADMIN_SECRET }}
        run: python3 scripts/ci/workflows/deploy_gateway.py --step deploy
