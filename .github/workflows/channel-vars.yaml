name: channel vars

on:
  workflow_call:
    inputs:
      github_event_name:
        type: string
      github_ref_name:
        type: string
        required: false
      workflow_dispatch_channel:
        type: string
        required: false

    outputs:
      channel:
        description: 'Computed release channel (stable|canary)'
        value: ${{ jobs.emit.outputs.channel }}
      is_canary:
        description: 'Whether this is a canary deploy (true|false)'
        value: ${{ jobs.emit.outputs.is_canary }}
      stack_suffix:
        description: "Suffix for stack/image names ('' or '-canary')"
        value: ${{ jobs.emit.outputs.stack_suffix }}

jobs:
  emit:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    outputs:
      channel: ${{ steps.compute.outputs.channel }}
      is_canary: ${{ steps.compute.outputs.is_canary }}
      stack_suffix: ${{ steps.compute.outputs.stack_suffix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          sparse-checkout: scripts/ci
          sparse-checkout-cone-mode: false

      - name: Determine channel
        id: compute
        shell: bash
        run: >-
          python3 scripts/ci/workflows/channel_vars.py
          --event-name "${{ inputs.github_event_name }}"
          --ref-name "${{ inputs.github_ref_name || '' }}"
          --dispatch-channel "${{ inputs.workflow_dispatch_channel || '' }}"
