services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ..:/workspace:cached
    command: sleep infinity

  valkey:
    image: valkey/valkey:8-alpine
    restart: unless-stopped
    command: ['valkey-server', '--appendonly', 'yes', '--save', '60', '1', '--loglevel', 'warning']
    volumes:
      - valkey-data:/data
    healthcheck:
      test: ['CMD', 'valkey-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5

  meilisearch:
    image: getmeili/meilisearch:v1.14
    restart: unless-stopped
    environment:
      MEILI_NO_ANALYTICS: 'true'
      MEILI_ENV: development
      MEILI_MASTER_KEY: fluxer-devcontainer-meili-master-key
    volumes:
      - meilisearch-data:/meili_data
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:7700/health']
      interval: 10s
      timeout: 5s
      retries: 5

  livekit:
    image: livekit/livekit-server:v1.9
    restart: unless-stopped
    command: --config /etc/livekit.yaml
    volumes:
      - ./livekit.yaml:/etc/livekit.yaml:ro

  mailpit:
    image: axllent/mailpit:latest
    restart: unless-stopped
    command: ['--webroot', '/mailpit/']

  nats-core:
    image: nats:2-alpine
    restart: unless-stopped
    command: ['--port', '4222']

  nats-jetstream:
    image: nats:2-alpine
    restart: unless-stopped
    command: ['--port', '4223', '--jetstream', '--store_dir', '/data']
    volumes:
      - nats-jetstream-data:/data

volumes:
  valkey-data:
  meilisearch-data:
  nats-jetstream-data:
